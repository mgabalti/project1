!function(t,r){"object"==typeof exports&&"undefined"!=typeof module?module.exports=r():"function"==typeof define&&define.amd?define(r):(t||self).ColorThief=r()}(this,function(){function o(t){this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.width=this.canvas.width=t.naturalWidth,this.height=this.canvas.height=t.naturalHeight,this.context.drawImage(t,0,0,this.width,this.height)}var d,m,x=x||{map:function(t,n){var o={};return n?t.map(function(t,r){return o.index=r,n.call(o,t)}):t.slice()},naturalOrder:function(t,r){return t<r?-1:r<t?1:0},sum:function(t,o){var e={};return t.reduce(o?function(t,r,n){return e.index=n,t+o.call(e,r)}:function(t,r){return t+r},0)},max:function(t,r){return Math.max.apply(null,r?x.map(t,r):t)}},e=(m=8-(d=5),C.prototype={volume:function(t){var r=this;return r._volume&&!t||(r._volume=(r.r2-r.r1+1)*(r.g2-r.g1+1)*(r.b2-r.b1+1)),r._volume},count:function(t){var r=this,n=r.histo;if(!r._count_set||t){for(var o,e,i=0,u=r.r1;u<=r.r2;u++)for(o=r.g1;o<=r.g2;o++)for(e=r.b1;e<=r.b2;e++)i+=n[y(u,o,e)]||0;r._count=i,r._count_set=!0}return r._count},copy:function(){var t=this;return new C(t.r1,t.r2,t.g1,t.g2,t.b1,t.b2,t.histo)},avg:function(t){var r=this,n=r.histo;if(!r._avg||t){for(var o,e,i,u=0,a=1<<8-d,c=0,f=0,s=0,h=r.r1;h<=r.r2;h++)for(e=r.g1;e<=r.g2;e++)for(i=r.b1;i<=r.b2;i++)u+=o=n[y(h,e,i)]||0,c+=o*(h+.5)*a,f+=o*(e+.5)*a,s+=o*(i+.5)*a;r._avg=u?[~~(c/u),~~(f/u),~~(s/u)]:[~~(a*(r.r1+r.r2+1)/2),~~(a*(r.g1+r.g2+1)/2),~~(a*(r.b1+r.b2+1)/2)]}return r._avg},contains:function(t){var r=this,n=t[0]>>m;return gval=t[1]>>m,bval=t[2]>>m,n>=r.r1&&n<=r.r2&&gval>=r.g1&&gval<=r.g2&&bval>=r.b1&&bval<=r.b2}},_.prototype={push:function(t){this.vboxes.push({vbox:t,color:t.avg()})},palette:function(){return this.vboxes.map(function(t){return t.color})},size:function(){return this.vboxes.size()},map:function(t){for(var r=this.vboxes,n=0;n<r.size();n++)if(r.peek(n).vbox.contains(t))return r.peek(n).color;return this.nearest(t)},nearest:function(t){for(var r,n,o,e=this.vboxes,i=0;i<e.size();i++)((n=Math.sqrt(Math.pow(t[0]-e.peek(i).color[0],2)+Math.pow(t[1]-e.peek(i).color[1],2)+Math.pow(t[2]-e.peek(i).color[2],2)))<r||void 0===r)&&(r=n,o=e.peek(i).color);return o},forcebw:function(){var t=this.vboxes,r=(t.sort(function(t,r){return x.naturalOrder(x.sum(t.color),x.sum(r.color))}),t[0].color),r=(r[0]<5&&r[1]<5&&r[2]<5&&(t[0].color=[0,0,0]),t.length-1),n=t[r].color;251<n[0]&&251<n[1]&&251<n[2]&&(t[r].color=[255,255,255])}},function(t,r){if(!t.length||r<2||256<r)return!1;e=t,o=new Array(1<<3*d),e.forEach(function(t){n=y(t[0]>>m,t[1]>>m,t[2]>>m),o[n]=(o[n]||0)+1});var n,o,e,i,u,a,c,f,s,h,l=o,t=(l.forEach(function(){}),e=l,s=c=u=1e6,h=f=a=0,t.forEach(function(t){(i=t[0]>>m)<u?u=i:a<i&&(a=i),(i=t[1]>>m)<c?c=i:f<i&&(f=i),(i=t[2]>>m)<s?s=i:h<i&&(h=i)}),new C(u,a,c,f,s,h,e)),v=new w(function(t,r){return x.naturalOrder(t.count(),r.count())});function g(t,r){for(var n,o=t.size(),e=0;e<1e3;){if(r<=o)return;if(1e3<e++)return;if((n=t.pop()).count()){var i=function(t,r){if(r.count()){var n=r.r2-r.r1+1,o=r.g2-r.g1+1,e=x.max([n,o,r.b2-r.b1+1]);if(1==r.count())return[r.copy()];var i,u,a,c,f=0,s=[],h=[];if(e==n)for(i=r.r1;i<=r.r2;i++){for(c=0,u=r.g1;u<=r.g2;u++)for(a=r.b1;a<=r.b2;a++)c+=t[y(i,u,a)]||0;s[i]=f+=c}else if(e==o)for(i=r.g1;i<=r.g2;i++){for(c=0,u=r.r1;u<=r.r2;u++)for(a=r.b1;a<=r.b2;a++)c+=t[y(u,i,a)]||0;s[i]=f+=c}else for(i=r.b1;i<=r.b2;i++){for(c=0,u=r.r1;u<=r.r2;u++)for(a=r.g1;a<=r.g2;a++)c+=t[y(u,a,i)]||0;s[i]=f+=c}s.forEach(function(t,r){h[r]=f-t});var l,v,g,p,b,n=e==n?"r":e==o?"g":"b",d=n+"1",m=n+"2",w=0;for(i=r[d];i<=r[m];i++)if(s[i]>f/2){for(g=r.copy(),p=r.copy(),b=(l=i-r[d])<=(v=r[m]-i)?Math.min(r[m]-1,~~(i+v/2)):Math.max(r[d],~~(i-1-l/2));!s[b];)b++;for(w=h[b];!w&&s[b-1];)w=h[--b];return g[m]=b,p[d]=g[m]+1,[g,p]}}}(l,n),u=i[0],i=i[1];if(!u)return;t.push(u),i&&(t.push(i),o++)}else t.push(n),e++}}v.push(t),g(v,.75*r);for(var p=new w(function(t,r){return x.naturalOrder(t.count()*t.volume(),r.count()*r.volume())});v.size();)p.push(v.pop());g(p,r);for(var b=new _;p.size();)b.push(p.pop());return b});function y(t,r,n){return(t<<2*d)+(r<<d)+n}function w(t){var r=[],n=!1;function o(){r.sort(t),n=!0}return{push:function(t){r.push(t),n=!1},peek:function(t){return n||o(),void 0===t&&(t=r.length-1),r[t]},pop:function(){return n||o(),r.pop()},size:function(){return r.length},map:function(t){return r.map(t)},debug:function(){return n||o(),r}}}function C(t,r,n,o,e,i,u){var a=this;a.r1=t,a.r2=r,a.g1=n,a.g2=o,a.b1=e,a.b2=i,a.histo=u}function _(){this.vboxes=new w(function(t,r){return x.naturalOrder(t.vbox.count()*t.vbox.volume(),r.vbox.count()*r.vbox.volume())})}o.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)};function t(){}return t.prototype.getColor=function(t,r){return this.getPalette(t,5,r=void 0===r?10:r)[0]},t.prototype.getPalette=function(t,r,n){r=function(t){var r=t.colorCount,t=t.quality;if(void 0!==r&&Number.isInteger(r)){if(1===r)throw new Error("colorCount should be between 2 and 20. To get one color, call getColor() instead of getPalette()");r=Math.max(r,2),r=Math.min(r,20)}else r=10;return{colorCount:r,quality:t=void 0===t||!Number.isInteger(t)||t<1?10:t}}({colorCount:r,quality:n}),n=new o(t),t=function(t,r,n){for(var o,e,i,u,a=t,c=[],f=0;f<r;f+=n)o=a[0+(u=4*f)],e=a[1+u],i=a[2+u],!(void 0===(u=a[3+u])||125<=u)||250<o&&250<e&&250<i||c.push([o,e,i]);return c}(n.getImageData().data,n.width*n.height,r.quality),n=e(t,r.colorCount);return n?n.palette():null},t.prototype.getColorFromUrl=function(r,n,o){var e=this,i=document.createElement("img");i.addEventListener("load",function(){var t=e.getPalette(i,5,o);n(t[0],r)}),i.src=r},t.prototype.getImageData=function(t,e){var r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onload=function(){if(200==this.status){var t=new Uint8Array(this.response);i=t.length;for(var r=new Array(i),n=0;n<t.length;n++)r[n]=String.fromCharCode(t[n]);var o=r.join(""),o=window.btoa(o);e("data:image/png;base64,"+o)}},r.send()},t.prototype.getColorAsync=function(t,n,o){var e=this;this.getImageData(t,function(t){var r=document.createElement("img");r.addEventListener("load",function(){var t=e.getPalette(r,5,o);n(t[0],this)}),r.src=t})},t});